@page
@model SistemaChamados.Pages.Configs.ConfigurarModel
@using Microsoft.AspNetCore.Authorization
@{
    ViewData["Title"] = "Configurações";
    bool isAdminOrTechnician = User.IsInRole("Admin") || User.IsInRole("Tecnico");
    bool isAdmin = User.IsInRole("Admin");
    bool isUsuario = User.IsInRole("Usuario");
}

<div class="container-fluid config-page py-3">

    <!-- Título + subtítulo -->
    <div class="mb-3">
        <h1 class="fw-bold display-6 mb-1">Configurações</h1>
        <p class="text-muted mb-0">Gerencie suas preferências e configurações do sistema</p>
    </div>

    <!-- Tabs (barra) -->
    <div class="bg-white border rounded-3 p-1 mb-3 shadow-sm">
        <ul class="nav nav-pills nav-fill gap-1 config-tabs" id="configTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(Model.ActiveTab == "pane-senha" ? "active" : "")" id="tab-senha"
                        data-bs-toggle="tab" data-bs-target="#pane-senha" type="button" role="tab"
                        aria-controls="pane-senha" aria-selected="@(Model.ActiveTab == "pane-senha" ? "true" : "false")">
                    <i class="bi bi-lock me-2"></i> <span>Senha</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(Model.ActiveTab == "pane-tema" ? "active" : "")" id="tab-tema"
                        data-bs-toggle="tab" data-bs-target="#pane-tema" type="button" role="tab"
                        aria-controls="pane-tema" aria-selected="@(Model.ActiveTab == "pane-tema" ? "true" : "false")">
                    <i class="bi bi-palette me-2"></i> <span>Tema</span>
                </button>
            </li>
            
            @* Aba Usuários - APENAS Admin/Técnico *@
            @if (isAdminOrTechnician)
            {
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(Model.ActiveTab == "pane-usuarios" ? "active" : "")" id="tab-usuarios"
                            data-bs-toggle="tab" data-bs-target="#pane-usuarios" type="button" role="tab"
                            aria-controls="pane-usuarios" aria-selected="@(Model.ActiveTab == "pane-usuarios" ? "true" : "false")">
                        <i class="bi bi-people me-2"></i> <span>Usuários</span>
                    </button>
                </li>
            }
        </ul>
    </div>

    <!-- Conteúdo das tabs -->
    <div class="tab-content">

       <!-- PANE: SENHA - TODOS OS USUÁRIOS -->
<div class="tab-pane fade @(Model.ActiveTab == "pane-senha" ? "show active" : "")" id="pane-senha" role="tabpanel" aria-labelledby="tab-senha">
    <div class="card shadow-sm border config-card">
        <div class="card-body p-4">
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-key me-2 fs-5"></i>
                <h5 class="card-title fw-bold mb-0">Alterar Senha</h5>
            </div>
            <p class="text-muted mb-4">Atualize sua senha para manter sua conta segura</p>

            @* Mensagem de erro geral *@
            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    @Model.ErrorMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <form method="post" asp-page-handler="AlterarSenha" novalidate autocomplete="off">
                @Html.AntiForgeryToken()
                
                <div class="mb-3">
                    <label asp-for="AlterarSenha.SenhaAtual" class="form-label fw-600">Senha Atual *</label>
                    <input asp-for="AlterarSenha.SenhaAtual" 
                           type="password" 
                           class="form-control form-control-lg rounded-3 config-control @(ViewData.ModelState["AlterarSenha.SenhaAtual"]?.Errors.Any() == true ? "is-invalid" : "")"
                           placeholder="Digite sua senha atual"
                           autocomplete="current-password" />
                    <span asp-validation-for="AlterarSenha.SenhaAtual" class="text-danger small d-block mt-1"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="AlterarSenha.NovaSenha" class="form-label fw-600">Nova Senha *</label>
                    <input asp-for="AlterarSenha.NovaSenha" 
                           type="password" 
                           class="form-control form-control-lg rounded-3 config-control @(ViewData.ModelState["AlterarSenha.NovaSenha"]?.Errors.Any() == true ? "is-invalid" : "")"
                           placeholder="Digite sua nova senha"
                           autocomplete="new-password" />
                    <span asp-validation-for="AlterarSenha.NovaSenha" class="text-danger small d-block mt-1"></span>
                    <small class="text-muted">Mínimo 8 caracteres com pelo menos um símbolo (@("!@#$%^&*"))</small>
                </div>

                <div class="mb-4">
                    <label asp-for="AlterarSenha.ConfirmarSenha" class="form-label fw-600">Confirmar Nova Senha *</label>
                    <input asp-for="AlterarSenha.ConfirmarSenha" 
                           type="password" 
                           class="form-control form-control-lg rounded-3 config-control @(ViewData.ModelState["AlterarSenha.ConfirmarSenha"]?.Errors.Any() == true ? "is-invalid" : "")"
                           placeholder="Confirme sua nova senha"
                           autocomplete="new-password" />
                    <span asp-validation-for="AlterarSenha.ConfirmarSenha" class="text-danger small d-block mt-1"></span>
                </div>

                @* Resumo de validação *@
                @if (!ViewData.ModelState.IsValid && ViewData.ModelState.Keys.Any(k => k.StartsWith("AlterarSenha")))
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        <strong>Corrija os erros acima antes de continuar:</strong>
                        <ul class="mb-0 mt-2">
                            @foreach (var key in ViewData.ModelState.Keys.Where(k => k.StartsWith("AlterarSenha")))
                            {
                                @foreach (var error in ViewData.ModelState[key].Errors)
                                {
                                    <li>@error.ErrorMessage</li>
                                }
                            }
                        </ul>
                    </div>
                }

                <button type="submit"
                        class="btn btn-primary btn-lg w-100 d-flex justify-content-center align-items-center">
                    <i class="bi bi-shield-lock me-2"></i>
                    Alterar Senha
                </button>
            </form>
        </div>
    </div>
</div>



        <!-- PANE: TEMA - TODOS OS USUÁRIOS -->
        <div class="tab-pane fade @(Model.ActiveTab == "pane-tema" ? "show active" : "")" id="pane-tema" role="tabpanel" aria-labelledby="tab-tema">
            <div class="card shadow-sm border config-card">
                <div class="card-body p-4">
                    @if (isUsuario)
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-palette fs-1 text-muted mb-3"></i>
                            <h5 class="text-muted">Personalizações de Tema</h5>
                            <p class="text-muted mb-0">Em breve você poderá personalizar a aparência do sistema.</p>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">Configurações de tema (em breve).</p>
                    }
                </div>
            </div>
        </div>

        <!-- PANE: USUÁRIOS (Admin/Técnico) -->
        @if (isAdminOrTechnician)
        {
            <div class="tab-pane fade @(Model.ActiveTab == "pane-usuarios" ? "show active" : "")" id="pane-usuarios" role="tabpanel" aria-labelledby="tab-usuarios">
                <div class="card shadow-sm border config-card">
                    <!-- Cabeçalho do card -->
                    <div class="p-4 border-bottom">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-shield-check me-2 fs-5"></i>
                            <div>
                                <h5 class="fw-bold mb-1">Gestão de Usuários</h5>
                                <div class="text-muted">Crie e visualize usuários do sistema</div>
                            </div>
                        </div>
                    </div>

                    @* MENSAGENS DE SUCESSO/ERRO *@
                    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
                    {
                        <div class="mx-4 mt-3">
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="bi bi-check-circle me-2"></i>
                                @Model.SuccessMessage
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="mx-4 mt-3">
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                @Model.ErrorMessage
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        </div>
                    }

                    <!-- Accordion -->
                    <div class="accordion accordion-flush" id="accUsuarios">
                        <!-- Item 1: Registro -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingManage">
                                <button class="accordion-button custom-accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseManage"
                                        aria-expanded="false" aria-controls="collapseManage">
                                    <i class="bi bi-person-plus me-2"></i> Registro de Usuários
                                </button>
                            </h2>
                            <div id="collapseManage" class="accordion-collapse collapse"
                                 aria-labelledby="headingManage" data-bs-parent="#accUsuarios">
                                <div class="accordion-body">

                                    @* Formulário *@
                                    <form method="post" asp-page-handler="CriarUsuario" novalidate autocomplete="off">
                                        @Html.AntiForgeryToken()
                                        
                                        <div class="row g-3">
                                            @* Nome e Sobrenome *@
                                            <div class="col-md-6">
                                                <label asp-for="CriarUsuario.Nome" class="form-label fw-600">Nome *</label>
                                                <input asp-for="CriarUsuario.Nome" 
                                                       class="form-control form-control-lg rounded-3 config-control"
                                                       placeholder="Digite o nome"
                                                       autocomplete="off" />
                                                <span asp-validation-for="CriarUsuario.Nome" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <label asp-for="CriarUsuario.Sobrenome" class="form-label fw-600">Sobrenome *</label>
                                                <input asp-for="CriarUsuario.Sobrenome" 
                                                       class="form-control form-control-lg rounded-3 config-control"
                                                       placeholder="Digite o sobrenome"
                                                       autocomplete="off" />
                                                <span asp-validation-for="CriarUsuario.Sobrenome" class="text-danger small"></span>
                                            </div>

                                            @* Email e Telefone *@
                                            <div class="col-md-6">
                                                <label asp-for="CriarUsuario.Email" class="form-label fw-600">E-mail *</label>
                                                <input asp-for="CriarUsuario.Email" 
                                                       type="email"
                                                       class="form-control form-control-lg rounded-3 config-control"
                                                       placeholder="Digite o e-mail"
                                                       autocomplete="new-email"
                                                       data-lpignore="true"
                                                       data-form-type="other" />
                                                <span asp-validation-for="CriarUsuario.Email" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <label asp-for="CriarUsuario.Telefone" class="form-label fw-600">Telefone</label>
                                                <input asp-for="CriarUsuario.Telefone" 
                                                       type="text"
                                                       class="form-control form-control-lg rounded-3 config-control"
                                                       placeholder="(11) 99999-9999"
                                                       maxlength="15"
                                                       id="telefoneInput"
                                                       autocomplete="off" />
                                                <span asp-validation-for="CriarUsuario.Telefone" class="text-danger small"></span>
                                            </div>

                                            @* Departamento e Cargo *@
                                            <div class="col-md-6">
                                                <label asp-for="CriarUsuario.Departamento" class="form-label fw-600">Departamento</label>
                                                <select asp-for="CriarUsuario.Departamento" class="form-select form-select-lg rounded-3 config-control" autocomplete="off">
                                                    <option value="">Selecione um departamento</option>
                                                    <option value="TI">Tecnologia da Informação</option>
                                                    <option value="RH">Recursos Humanos</option>
                                                    <option value="Financeiro">Financeiro</option>
                                                    <option value="Comercial">Comercial</option>
                                                    <option value="Marketing">Marketing</option>
                                                    <option value="Operacoes">Operações</option>
                                                    <option value="Juridico">Jurídico</option>
                                                    <option value="Diretoria">Diretoria</option>
                                                </select>
                                                <span asp-validation-for="CriarUsuario.Departamento" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <label asp-for="CriarUsuario.Cargo" class="form-label fw-600">Cargo</label>
                                                <select asp-for="CriarUsuario.Cargo" class="form-select form-select-lg rounded-3 config-control" autocomplete="off">
                                                    <option value="">Selecione um cargo</option>
                                                    <option value="Estagiario">Estagiário</option>
                                                    <option value="Analista Jr">Analista Júnior</option>
                                                    <option value="Analista Pleno">Analista Pleno</option>
                                                    <option value="Analista Sr">Analista Sênior</option>
                                                    <option value="Coordenador">Coordenador</option>
                                                    <option value="Supervisor">Supervisor</option>
                                                    <option value="Gerente">Gerente</option>
                                                    <option value="Diretor">Diretor</option>
                                                    <option value="Tecnico">Técnico</option>
                                                    <option value="Assistente">Assistente</option>
                                                </select>
                                                <span asp-validation-for="CriarUsuario.Cargo" class="text-danger small"></span>
                                            </div>

                                            @* Tipo de Usuário e Senha *@
                                            <div class="col-md-6">
                                                <label asp-for="CriarUsuario.TipoUsuario" class="form-label fw-600">Tipo de Usuário *</label>
                                                <select asp-for="CriarUsuario.TipoUsuario" class="form-select form-select-lg rounded-3 config-control" autocomplete="off">
                                                    <option value="">Selecione o tipo</option>
                                                    <option value="Usuario">Usuário</option>
                                                    <option value="Tecnico">Técnico</option>
                                                    <option value="Admin">Administrador</option>
                                                </select>
                                                <span asp-validation-for="CriarUsuario.TipoUsuario" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <label asp-for="CriarUsuario.Senha" class="form-label fw-600">Senha *</label>
                                                <input asp-for="CriarUsuario.Senha" 
                                                       type="password"
                                                       class="form-control form-control-lg rounded-3 config-control"
                                                       placeholder="Mínimo 8 caracteres com 1 símbolo"
                                                       autocomplete="new-password"
                                                       data-lpignore="true"
                                                       data-form-type="other" />
                                                <span asp-validation-for="CriarUsuario.Senha" class="text-danger small"></span>
                                            </div>

                                            @* Informações da senha *@
                                            <div class="col-12">
                                                <div class="form-text">
                                                    <small class="text-muted">
                                                        <i class="bi bi-info-circle me-1"></i>
                                                        <strong>*</strong> Campos obrigatórios | A senha deve ter no mínimo 8 caracteres e pelo menos um símbolo especial
                                                    </small>
                                                </div>
                                            </div>

                                            @* Botão Criar *@
                                            <div class="col-12">
                                                <button type="submit"
                                                        class="btn btn-primary btn-lg w-100 d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-person-plus-fill me-2"></i>
                                                    Criar Usuário
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Item 2: Tabela de Usuários (APENAS ADMIN) -->
                        @if (isAdmin)
                        {
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingView">
                                    <button class="accordion-button custom-accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseView"
                                            aria-expanded="false" aria-controls="collapseView">
                                        <i class="bi bi-table me-2"></i> Tabela de Usuários
                                    </button>
                                </h2>
                                <div id="collapseView" class="accordion-collapse collapse"
                                     aria-labelledby="headingView" data-bs-parent="#accUsuarios">
                                    <div class="accordion-body p-0">
                                        
                                        @if (Model.Usuarios.Any())
                                        {
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover mb-0">
                                                    <thead class="table-dark">
                                                        <tr>
                                                            <th>Nome</th>
                                                            <th>E-mail</th>
                                                            <th>Departamento</th>
                                                            <th>Cargo</th>
                                                            <th>Telefone</th>
                                                            <th>Tipo</th>
                                                            <th>Criado em</th>
                                                            <th>Modificado em</th>
                                                            <th width="100" class="text-center">Ações</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var usuario in Model.Usuarios)
                                                        {
                                                            <tr>
                                                                <td class="fw-medium">@usuario.Nome</td>
                                                                <td>@usuario.Email</td>
                                                                <td>
                                                                    @if (!string.IsNullOrEmpty(usuario.Departamento))
                                                                    {
                                                                        <span class="badge bg-secondary">@usuario.Departamento</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-muted">-</span>
                                                                    }
                                                                </td>
                                                                <td>
                                                                    @if (!string.IsNullOrEmpty(usuario.Cargo))
                                                                    {
                                                                        <span class="badge bg-info">@usuario.Cargo</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-muted">-</span>
                                                                    }
                                                                </td>
                                                                <td>@(usuario.Telefone ?? "-")</td>
                                                                <td>
                                                                    <span class="badge bg-@(usuario.TipoUsuario switch {
                                                                        "Admin" => "danger",
                                                                        "Tecnico" => "warning text-dark",
                                                                        _ => "primary"
                                                                    })">@usuario.TipoUsuario</span>
                                                                </td>
                                                                <td>
                                                                    <small class="text-muted">
                                                                        @usuario.CriadoEm.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                                                    </small>
                                                                </td>
                                                                <td>
                                                                    <small class="text-muted">
                                                                        @usuario.AtualizadoEm.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                                                    </small>
                                                                </td>
                                                                <td class="text-center">
                                                                    <button type="button" 
                                                                            class="btn btn-sm btn-outline-primary me-1"
                                                                            onclick="editarUsuario(@usuario.Id, '@Html.Raw(usuario.Nome.Replace("'", "\\'"))', '@Html.Raw(usuario.Email.Replace("'", "\\'"))', '@Html.Raw((usuario.Telefone ?? "").Replace("'", "\\'"))', '@Html.Raw((usuario.Departamento ?? "").Replace("'", "\\'"))', '@Html.Raw((usuario.Cargo ?? "").Replace("'", "\\'"))', '@usuario.TipoUsuario')"
                                                                            title="Editar usuário">
                                                                        <i class="bi bi-pencil"></i>
                                                                    </button>
                                                                    <button type="button" 
                                                                            class="btn btn-sm btn-outline-danger"
                                                                            onclick="excluirUsuario(@usuario.Id, '@Html.Raw(usuario.Nome.Replace("'", "\\'"))')"
                                                                            title="Excluir usuário">
                                                                        <i class="bi bi-trash"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="text-center p-4">
                                                <i class="bi bi-people fs-1 text-muted mb-3"></i>
                                                <h5 class="text-muted">Nenhum usuário encontrado</h5>
                                                <p class="text-muted mb-0">Ainda não há usuários cadastrados no sistema.</p>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="tab-pane fade" id="pane-usuarios" role="tabpanel" aria-labelledby="tab-usuarios">
                <div class="card shadow-sm border config-card">
                    <div class="card-body p-4 text-center">
                        <i class="bi bi-shield-x fs-1 text-muted mb-3"></i>
                        <h5 class="text-muted">Acesso Restrito</h5>
                        <p class="text-muted mb-0">Apenas administradores e técnicos podem acessar esta seção.</p>
                    </div>
                </div>
            </div>
        }

    </div>
</div>

<!-- Modal de Edição de Usuário (APENAS ADMIN) -->
@if (isAdmin)
{
    <div class="modal fade" id="editarUsuarioModal" tabindex="-1" aria-labelledby="editarUsuarioModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editarUsuarioModalLabel">
                        <i class="bi bi-person-gear me-2"></i>Editar Usuário
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <form method="post" asp-page-handler="EditarUsuario" novalidate autocomplete="off">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="EditarUsuario.Id" />

                    <div class="modal-body">
                        <div class="row g-3">
                            <!-- Nome e Sobrenome -->
                            <div class="col-md-6">
                                <label asp-for="EditarUsuario.Nome" class="form-label">Nome *</label>
                                <input asp-for="EditarUsuario.Nome" 
                                       class="form-control" 
                                       autocomplete="off" />
                                <span asp-validation-for="EditarUsuario.Nome" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="EditarUsuario.Sobrenome" class="form-label">Sobrenome *</label>
                                <input asp-for="EditarUsuario.Sobrenome" 
                                       class="form-control" 
                                       autocomplete="off" />
                                <span asp-validation-for="EditarUsuario.Sobrenome" class="text-danger small"></span>
                            </div>

                            <!-- Email e Telefone -->
                            <div class="col-md-6">
                                <label asp-for="EditarUsuario.Email" class="form-label">E-mail *</label>
                                <input asp-for="EditarUsuario.Email" 
                                       type="email"
                                       class="form-control" 
                                       autocomplete="new-email" />
                                <span asp-validation-for="EditarUsuario.Email" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="EditarUsuario.Telefone" class="form-label">Telefone</label>
                                <input asp-for="EditarUsuario.Telefone" 
                                       type="text"
                                       class="form-control" 
                                       placeholder="(11) 99999-9999"
                                       maxlength="15"
                                       id="editTelefone"
                                       autocomplete="off" />
                                <span asp-validation-for="EditarUsuario.Telefone" class="text-danger small"></span>
                            </div>

                            <!-- Departamento e Cargo -->
                            <div class="col-md-6">
                                <label asp-for="EditarUsuario.Departamento" class="form-label">Departamento</label>
                                <select asp-for="EditarUsuario.Departamento" class="form-select">
                                    <option value="">Selecione um departamento</option>
                                    <option value="TI">Tecnologia da Informação</option>
                                    <option value="RH">Recursos Humanos</option>
                                    <option value="Financeiro">Financeiro</option>
                                    <option value="Comercial">Comercial</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Operacoes">Operações</option>
                                    <option value="Juridico">Jurídico</option>
                                    <option value="Diretoria">Diretoria</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="EditarUsuario.Cargo" class="form-label">Cargo</label>
                                <select asp-for="EditarUsuario.Cargo" class="form-select">
                                    <option value="">Selecione um cargo</option>
                                    <option value="Estagiario">Estagiário</option>
                                    <option value="Analista Jr">Analista Júnior</option>
                                    <option value="Analista Pleno">Analista Pleno</option>
                                    <option value="Analista Sr">Analista Sênior</option>
                                    <option value="Coordenador">Coordenador</option>
                                    <option value="Supervisor">Supervisor</option>
                                    <option value="Gerente">Gerente</option>
                                    <option value="Diretor">Diretor</option>
                                    <option value="Tecnico">Técnico</option>
                                    <option value="Assistente">Assistente</option>
                                </select>
                            </div>

                            <!-- Tipo de Usuário e Nova Senha -->
                            <div class="col-md-6">
                                <label asp-for="EditarUsuario.TipoUsuario" class="form-label">Tipo de Usuário *</label>
                                <select asp-for="EditarUsuario.TipoUsuario" class="form-select">
                                    <option value="Usuario">Usuário</option>
                                    <option value="Tecnico">Técnico</option>
                                    <option value="Admin">Administrador</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="EditarUsuario.NovaSenha" class="form-label">Nova Senha</label>
                                <input asp-for="EditarUsuario.NovaSenha" 
                                       type="password"
                                       class="form-control" 
                                       placeholder="Deixe em branco para manter atual"
                                       autocomplete="new-password" />
                                <span asp-validation-for="EditarUsuario.NovaSenha" class="text-danger small"></span>
                                <small class="text-muted">Deixe em branco para não alterar a senha</small>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Máscara de telefone para o formulário de criar
    const telefoneInput = document.getElementById('telefoneInput');
    
    if (telefoneInput) {
        telefoneInput.addEventListener('input', aplicarMascaraTelefone);
    }

    // Máscara para telefone no modal de edição
    const editTelefoneInput = document.getElementById('editTelefone');
    
    if (editTelefoneInput) {
        editTelefoneInput.addEventListener('input', aplicarMascaraTelefone);
    }
    
    function aplicarMascaraTelefone(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        if (value.length > 0) {
            if (value.length <= 2) {
                value = '(' + value;
            } else if (value.length <= 7) {
                value = '(' + value.slice(0, 2) + ') ' + value.slice(2);
            } else {
                value = '(' + value.slice(0, 2) + ') ' + value.slice(2, 7) + '-' + value.slice(7, 11);
            }
        }
        
        e.target.value = value;
    }
});

// Verificar se usuário é admin
var isUserAdmin = @(isAdmin ? "true" : "false");

if (isUserAdmin) {
    function editarUsuario(id, nomeCompleto, email, telefone, departamento, cargo, tipoUsuario) {
        console.log('Editando usuário:', { id, nomeCompleto, email, telefone, departamento, cargo, tipoUsuario });
        
        // Separar nome e sobrenome
        const partesNome = nomeCompleto.split(' ');
        const nome = partesNome[0] || '';
        const sobrenome = partesNome.slice(1).join(' ') || '';
        
        // Preencher campos do modal usando os nomes asp-for corretos
        document.querySelector('input[name="EditarUsuario.Id"]').value = id;
        document.querySelector('input[name="EditarUsuario.Nome"]').value = nome;
        document.querySelector('input[name="EditarUsuario.Sobrenome"]').value = sobrenome;
        document.querySelector('input[name="EditarUsuario.Email"]').value = email;
        document.querySelector('input[name="EditarUsuario.Telefone"]').value = telefone || '';
        document.querySelector('select[name="EditarUsuario.Departamento"]').value = departamento || '';
        document.querySelector('select[name="EditarUsuario.Cargo"]').value = cargo || '';
        document.querySelector('select[name="EditarUsuario.TipoUsuario"]').value = tipoUsuario;
        
        // Limpar campo de nova senha
        document.querySelector('input[name="EditarUsuario.NovaSenha"]').value = '';
        
        // Exibir modal
        const modal = new bootstrap.Modal(document.getElementById('editarUsuarioModal'));
        modal.show();
    }

    function excluirUsuario(id, nome) {
        if (confirm('Tem certeza que deseja excluir o usuário "' + nome + '"?\n\nEsta ação não pode ser desfeita.')) {
            alert('Funcionalidade de exclusão ainda não implementada');
        }
    }
}
</script>
